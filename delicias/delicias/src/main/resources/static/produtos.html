<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doce Sabor ‚Äî Produtos</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="img/delicias da fer.png" alt="Delicias da Fer Lopes" class="logo" />
        <div class="brand-text">
          <h1>Delicias</h1>
          <small>Fer Lopes</small>
        </div>
      </div>
      <nav class="main-nav">
        <a class="nav-link" href="index.html">In√≠cio</a>
        <a class="nav-link active" href="produtos.html">Produtos</a>
        <a class="nav-link" href="sobre.html">Sobre</a>
        <a class="nav-link" href="carrinho.html">Carrinho</a>
      </nav>
      <div class="header-actions">
        <a class="phone" href="tel:+5511999999999">üìû (15) 99717-2394</a>
        <a class="cart-link" href="carrinho.html">üõí <span id="cart-count-badge">0</span></a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="section hero small-hero" style="
      position: relative;
      background-image: url('img/3e30b902036cb2ece2dedcb1822b0070.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #fff;
      overflow: hidden;
    ">
    <div style="
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.419);
        z-index: 0;
      "></div>
    <div class="container" style="
        position: relative;
        z-index: 1;
        text-align: center;
        animation: fadeSlideUp 1s ease-out;
      ">
      <h2 class="section-title"></h2>
    </div>
  </section>

  <main class="container produtos-page">
    <!-- FILTROS -->
    <div class="filtros">
      <input type="text" id="searchInput" placeholder="Buscar produto..." />

      </select>
    </div>

    <!-- BOT√ÉO SOMENTE PARA CONFEITEIRA -->
    <div id="adminArea" style="display: none; text-align: center; margin: 20px 0"></div>

    <!-- GRID DE PRODUTOS -->
    <div id="produtosGrid" class="grid-cardapio"></div>

    <!-- FORMUL√ÅRIO DE ADI√á√ÉO -->
    <div id="addProdutoForm" style="display: none; margin-top: 30px">
      <h3>Adicionar Novo Produto</h3>
      <input type="text" id="nomeProduto" placeholder="Nome do produto" required />
      <input type="text" id="precoProduto" placeholder="Pre√ßo (ex: R$ 25,00)" required />
      <input type="text" id="categoriaProduto" placeholder="Categoria (bolo, doce...)" required />
      <input type="text" id="imagemProduto" placeholder="URL da imagem" required />
      <button id="salvarProduto" class="btn primary">Salvar Produto</button>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div>¬© <span id="year"></span> Delicias Fer Lopes ‚Äî Todos os direitos reservados.</div>
      <div>üìû (15) 99717-2394 ‚Ä¢ Sorocaba</div>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const adminArea = document.getElementById("adminArea");
      const addProdutoForm = document.getElementById("addProdutoForm");
      const produtosGrid = document.getElementById("produtosGrid");
      const salvarProduto = document.getElementById("salvarProduto");
      const searchInput = document.getElementById("searchInput");
      const filterCategory = document.getElementById("filterCategory");
      const API_URL = "http://localhost:8080/produtos";
      const IMG_FALLBACK = "img/placeholder.jpg";
      let produtos = [];
      let filtrados = [];

      // ------ ADMIN (login da confeiteira) ------
      const isLogada = localStorage.getItem("isConfeiteiraLogada") === "true";
      if (isLogada) {
        adminArea.innerHTML = `
          <button id="btnAddProduto" class="btn primary">‚ûï Adicionar Novo Produto</button>
          <button id="btnRemoverProduto" class="btn danger" style="margin-left:10px;">üóëÔ∏è Remover Produto</button>
        `;
        adminArea.style.display = "block";
        document.getElementById("btnAddProduto").addEventListener("click", () => {
          addProdutoForm.style.display =
            addProdutoForm.style.display === "none" ? "block" : "none";
        });
        document.getElementById("btnRemoverProduto").addEventListener("click", ativarRemocao);
      }

      function ativarRemocao() {
        const cards = document.querySelectorAll(".card-produto");
        cards.forEach((card) => {
          if (!card.querySelector(".delete-btn")) {
            const btnDel = document.createElement("button");
            btnDel.textContent = "‚ùå";
            btnDel.className = "delete-btn";
            Object.assign(btnDel.style, {
              position: "absolute",
              top: "5px",
              right: "5px",
              background: "#ff4d4d",
              color: "#fff",
              border: "none",
              borderRadius: "50%",
              width: "25px",
              height: "25px",
              cursor: "pointer",
              fontSize: "14px",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
            });
            btnDel.title = "Remover produto";
            btnDel.addEventListener("click", () => {
              if (confirm("Tem certeza que deseja remover este produto?")) {
                card.remove();
              }
            });
            card.style.position = "relative";
            card.appendChild(btnDel);
          }
        });
        alert("Modo de remo√ß√£o ativado! Clique no ‚ùå para excluir um produto.");
      }

      // ------ FETCH + RENDER ------
      async function carregarProdutos() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          produtos = Array.isArray(data) ? data : [];
          filtrados = [...produtos];
          renderGrid(filtrados);
        } catch (err) {
          console.error("‚ùå Erro ao buscar produtos:", err);
          produtosGrid.innerHTML = `<p style="text-align:center;">N√£o foi poss√≠vel carregar os produtos agora.</p>`;
        }
      }

      function criarCard(p) {
        const precoBRL =
          typeof p.precoProduto === "number"
            ? p.precoProduto.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL",
              })
            : p.precoProduto;

        const card = document.createElement("div");
        card.className = "card-produto";
        card.innerHTML = `
          <div class="thumb">
            <img alt="${p.nomeProduto}">
          </div>
          <div class="info">
            <h3>${p.nomeProduto}</h3>
            ${p.descricaoProduto ? `<p class="desc">${p.descricaoProduto}</p>` : ""}
            ${precoBRL ? `<p class="preco">${precoBRL}</p>` : ""}
            <button class="btn">Adicionar ao Carrinho</button>
          </div>
        `;

        const botao = card.querySelector(".btn");
        botao.addEventListener("click", () => {
          const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
          carrinho.push({
            nome: p.nomeProduto,
            descricao: p.descricaoProduto,
            preco: precoBRL,
            imgUrl: p.imgUrl || "",
          });
          localStorage.setItem("carrinho", JSON.stringify(carrinho));
          window.location.href = "carrinho.html";
        });

        const img = card.querySelector("img");
        img.src = p.imgUrl || IMG_FALLBACK;
        img.referrerPolicy = "no-referrer";
        img.loading = "lazy";
        img.onerror = () => {
          img.src = IMG_FALLBACK;
        };

        return card;
      }

      function renderGrid(lista) {
        produtosGrid.innerHTML = "";
        if (!lista.length) {
          produtosGrid.innerHTML = `<p style="text-align:center;">Nenhum produto encontrado.</p>`;
          return;
        }
        const frag = document.createDocumentFragment();
        lista.forEach((p) => frag.appendChild(criarCard(p)));
        produtosGrid.appendChild(frag);
      }

      // ------ BUSCA + FILTRO ------
      function aplicarFiltros() {
        const termo = (searchInput?.value || "").toLowerCase().trim();
        const categoria = (filterCategory?.value || "").toLowerCase().trim();

        filtrados = produtos.filter((p) => {
          const nomeOk = p.nomeProduto?.toLowerCase().includes(termo);
          const descOk = p.descricaoProduto?.toLowerCase().includes(termo);
          const passaTexto = termo ? nomeOk || descOk : true;
          const passaCategoria = categoria
            ? p.categoria?.toLowerCase() === categoria
            : true;
          return passaTexto && passaCategoria;
        });
        renderGrid(filtrados);
      }

      searchInput?.addEventListener("input", aplicarFiltros);
      filterCategory?.addEventListener("change", aplicarFiltros);

      // ------ ADI√á√ÉO LOCAL (admin) ------
      salvarProduto.addEventListener("click", () => {
        const nome = document.getElementById("nomeProduto").value.trim();
        const preco = document.getElementById("precoProduto").value.trim();
        const categoria = document.getElementById("categoriaProduto").value.trim();
        const imagem = document.getElementById("imagemProduto").value.trim();

        if (!nome || !preco || !imagem) {
          alert("Preencha todos os campos!");
          return;
        }

        const novo = {
          idProduto: Date.now(),
          nomeProduto: nome,
          precoProduto:
            Number(
              preco.replace("R$", "").replace(".", "").replace(",", ".").trim()
            ) || preco,
          descricaoProduto: "",
          imgUrl: imagem,
          categoria: categoria || "",
        };

        produtos.push(novo);
        aplicarFiltros();

        document.getElementById("nomeProduto").value = "";
        document.getElementById("precoProduto").value = "";
        document.getElementById("categoriaProduto").value = "";
        document.getElementById("imagemProduto").value = "";
        addProdutoForm.style.display = "none";
      });

      // ------ RODA ------
      carregarProdutos();

      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>
